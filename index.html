<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vilin Mestari Sijoitus Voitot</title>
  <style>
    /* Teemat */
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
      background: #f4f7fa;
      color: #333;
      transition: background-color 0.3s, color 0.3s;
    }
    [data-theme="dark"] body {
      background: #121212;
      color: #e0e0e0;
    }
    [data-theme="blue"] body {
      background: #e3f2fd;
      color: #0d47a1;
    }

    /* Buttonit */
    button {
      cursor: pointer;
      padding: 0.4rem 1rem;
      margin: 0.2rem;
      border-radius: 4px;
      border: none;
      background-color: #2196f3;
      color: white;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #1976d2;
    }
    [data-theme="dark"] button {
      background-color: #444;
      color: #eee;
    }
    [data-theme="dark"] button:hover {
      background-color: #666;
    }
    [data-theme="blue"] button {
      background-color: #1a73e8;
      color: white;
    }
    [data-theme="blue"] button:hover {
      background-color: #155ab6;
    }

    /* Lomake */
    form > div {
      margin-bottom: 1rem;
    }
    label {
      display: block;
      margin-bottom: 0.3rem;
    }
    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      max-width: 300px;
      padding: 0.4rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    /* Taulukko */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      padding: 0.5rem;
      border: 1px solid #ccc;
      text-align: left;
    }
    th {
      background-color: #ddd;
    }
    [data-theme="dark"] th {
      background-color: #333;
    }

    /* Teeman valintapainikkeet */
    #themeButtons button {
      margin-right: 0.5rem;
    }

    #userInfo {
      margin-top: 1rem;
      margin-bottom: 1rem;
      font-weight: bold;
    }

  </style>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
</head>
<body data-theme="light">

  <h1>Vilin Mestari Sijoitus Voitot</h1>

  <div id="themeButtons">
    <button id="lightBtn">Vaalea</button>
    <button id="darkBtn">Tumma</button>
    <button id="blueBtn">Sininen</button>
  </div>

  <div id="userInfo">
    Ei kirjautunut <button id="loginBtn">Kirjaudu Googlella</button>
  </div>

  <form id="addSkinForm" aria-label="Lisää uusi skin" style="display:none;">
    <div>
      <label for="name">Skinin nimi</label>
      <input id="name" name="name" type="text" required />
    </div>
    <div>
      <label for="buyPrice">Ostohinta (€)</label>
      <input id="buyPrice" name="buyPrice" type="number" step="0.01" required />
    </div>
    <div>
      <label for="sellPrice">Myyntihinta (€)</label>
      <input id="sellPrice" name="sellPrice" type="number" step="0.01" required />
    </div>
    <div>
      <label for="condition">Kunto</label>
      <select id="condition" name="condition" required>
        <option value="">Valitse...</option>
        <option value="Factory New">Factory New</option>
        <option value="Minimal Wear">Minimal Wear</option>
        <option value="Field-Tested">Field-Tested</option>
        <option value="Well-Worn">Well-Worn</option>
        <option value="Battle-Scarred">Battle-Scarred</option>
      </select>
    </div>
    <div>
      <label for="purchaseSource">Ostettu</label>
      <select id="purchaseSource" name="purchaseSource" required>
        <option value="">Valitse...</option>
        <option value="Steam">Steam</option>
        <option value="CSFloat">CSFloat</option>
      </select>
    </div>
    <button type="submit" id="addSkinBtn">Lisää skin</button>
  </form>

  <table id="skinsTable" aria-label="Skinit taulukko" style="display:none;">
    <thead>
      <tr>
        <th>Nimi</th>
        <th>Ostohinta (€)</th>
        <th>Myyntihinta (€)</th>
        <th>Kunto</th>
        <th>Ostolähde</th>
        <th>Voitto (€)</th>
        <th>Toiminnot</th>
      </tr>
    </thead>
    <tbody>
      <!-- Skinit renderöidään tänne -->
    </tbody>
  </table>

  <script>
    // === Firebase-konfiguraatio (vaihda omiin arvoihisi) ===
    const firebaseConfig = {
      apiKey: "AIzaSyDj3YnvlbQPM5yvlYTEohrup65bQCBbwDY",
  authDomain: "vilin-mestari-sijoitus-voitot.firebaseapp.com",
  projectId: "vilin-mestari-sijoitus-voitot",
  storageBucket: "vilin-mestari-sijoitus-voitot.firebasestorage.app",
  messagingSenderId: "912067809877",
  appId: "1:912067809877:web:84c11fc354f5372dcb7adc",
  measurementId: "G-5683KL29W1"
    };

    // Firebase alustaminen
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM-elementit
    const userInfo = document.getElementById('userInfo');
    const loginBtn = document.getElementById('loginBtn');
    const addSkinForm = document.getElementById('addSkinForm');
    const skinsTable = document.getElementById('skinsTable');
    const skinsTableBody = skinsTable.querySelector('tbody');

    let skins = [];
    let editIndex = -1;
    let currentUser = null;

    // Teemapainikkeet
    const lightBtn = document.getElementById('lightBtn');
    const darkBtn = document.getElementById('darkBtn');
    const blueBtn = document.getElementById('blueBtn');

    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
    }

    lightBtn.addEventListener('click', () => setTheme('light'));
    darkBtn.addEventListener('click', () => setTheme('dark'));
    blueBtn.addEventListener('click', () => setTheme('blue'));

    // Kirjautuminen Googlella
    loginBtn.addEventListener('click', () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(e => alert("Kirjautumisvirhe: " + e.message));
    });

    // Kuuntele kirjautumistilaa
    auth.onAuthStateChanged(async (user) => {
      currentUser = user;
      if (user) {
        userInfo.innerHTML = `Kirjautunut: <span>${user.displayName}</span> <button id="logoutBtn">Kirjaudu ulos</button>`;
        document.getElementById('logoutBtn').addEventListener('click', () => auth.signOut());
        addSkinForm.style.display = 'block';
        skinsTable.style.display = 'table';
        loginBtn.style.display = 'none';
        await loadSkins();
        renderSkins();
      } else {
        userInfo.innerHTML = `Ei kirjautunut`;
        loginBtn.style.display = 'inline-block';
        addSkinForm.style.display = 'none';
        skinsTable.style.display = 'none';
        skins = [];
        renderSkins();
      }
    });

    // Lataa skinit Firestoresta
    async function loadSkins() {
      if (!currentUser) return;
      try {
        const docRef = db.collection('users').doc(currentUser.uid);
        const doc = await docRef.get();
        if (doc.exists) {
          skins = doc.data().skins || [];
        } else {
          skins = [];
        }
      } catch (e) {
        alert("Virhe skinien latauksessa: " + e.message);
      }
    }

    // Tallenna skinit Firestoreen
    async function saveSkins() {
      if (!currentUser) return;
      try {
        const docRef = db.collection('users').doc(currentUser.uid);
        await docRef.set({ skins });
      } catch (e) {
        alert("Virhe skinien tallennuksessa: " + e.message);
      }
    }

    // Lomakkeen käsittely
    addSkinForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const name = addSkinForm.name.value.trim();
      const buyPrice = parseFloat(addSkinForm.buyPrice.value);
      const sellPrice = parseFloat(addSkinForm.sellPrice.value);
      const condition = addSkinForm.condition.value;
      const purchaseSource = addSkinForm.purchaseSource.value;

      if (!name || isNaN(buyPrice) || isNaN(sellPrice) || !condition || !purchaseSource) {
        alert('Täytä kaikki kentät oikein.');
        return;
      }

      const newSkin = { name, buyPrice, sellPrice, condition, purchaseSource };

      if (editIndex === -1) {
        skins.push(newSkin);
      } else {
        skins[editIndex] = newSkin;
        editIndex = -1;
        addSkinForm.querySelector('button[type="submit"]').textContent = 'Lisää skin';
      }

      addSkinForm.reset();
      await saveSkins();
      renderSkins();
    });

    // Renderöi skin-taulukko
    function renderSkins() {
      skinsTableBody.innerHTML = '';
      skins.forEach((skin, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${skin.name}</td>
          <td>${skin.buyPrice.toFixed(2)}</td>
          <td>${skin.sellPrice.toFixed(2)}</td>
          <td>${skin.condition}</td>
          <td>${skin.purchaseSource}</td>
          <td>${(skin.sellPrice - skin.buyPrice).toFixed(2)}</td>
          <td>
            <button class="edit-btn" aria-label="Muokkaa skin ${skin.name}" data-index="${i}">Muokkaa</button>
            <button class="delete-btn" aria-label="Poista skin ${skin.name}" data-index="${i}">Poista</button>
          </td>
        `;
        skinsTableBody.appendChild(tr);
      });

      // Lisää event listenerit muokkaus- ja poistonapeille
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const i = parseInt(e.target.dataset.index);
          editIndex = i;
          const skin = skins[i];
          addSkinForm.name.value = skin.name;
          addSkinForm.buyPrice.value = skin.buyPrice;
          addSkinForm.sellPrice.value = skin.sellPrice;
          addSkinForm.condition.value = skin.condition;
          addSkinForm.purchaseSource.value = skin.purchaseSource;
          addSkinForm.querySelector('button[type="submit"]').textContent = 'Tallenna muutokset';
        });
      });

      document.querySelectorAll('.delete-btn').forEach(async btn => {
        btn.addEventListener('click', async (e) => {
          const i = parseInt(e.target.dataset.index);
          if (confirm(`Haluatko varmasti poistaa skinin "${skins[i].name}"?`)) {
            skins.splice(i, 1);
            if (editIndex === i) {
              editIndex = -1;
              addSkinForm.reset();
              addSkinForm.querySelector('button[type="submit"]').textContent = 'Lisää skin';
            }
            await saveSkins();
            renderSkins();
          }
        });
      });
    }

  </script>
</body>
</html>