<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vilin Mestari Sijoitus Voitot</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #user-info { margin-bottom: 15px; }
    #addSkinForm { margin-bottom: 20px; }
    table { border-collapse: collapse; width: 100%; max-width: 900px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #eee; }
    .profit { background-color: #d4f8d4; }   /* vihreä voitto */
    .loss { background-color: #f8d4d4; }     /* punainen tappio */
    button { cursor: pointer; }
  </style>
</head>
<body>

  <div id="user-info" style="display:none;">
    Tervetuloa, <span id="user-name"></span>!
    <button id="logout-btn">Kirjaudu ulos</button>
  </div>
  <button id="login-btn">Kirjaudu Googlella</button>

  <form id="addSkinForm" style="display:none;">
    <h2>Lisää tai muokkaa skin</h2>
    <input type="hidden" id="editIndex" value="-1" />
    <label>
      Skinin nimi: <input type="text" id="skinName" required />
    </label>
    <br />
    <label>
      Kulumamalli: 
      <select id="wearLevel" required>
        <option value="Factory New">Factory New</option>
        <option value="Minimal Wear">Minimal Wear</option>
        <option value="Field Tested">Field Tested</option>
        <option value="Well Worn">Well Worn</option>
        <option value="Battle Scarred">Battle Scarred</option>
      </select>
    </label>
    <br />
    <label>
      Osto (€/USD): <input type="number" step="0.01" id="buyPrice" required />
    </label>
    <br />
    <label>
      Myynti (€/USD): <input type="number" step="0.01" id="sellPrice" required />
    </label>
    <br />
    <label>
      Lähde ostolle: 
      <select id="buySource" required>
        <option value="CSFloat">CSFloat</option>
        <option value="Steam">Steam</option>
      </select>
    </label>
    <br />
    <label>
      Lähde myynnille: 
      <select id="sellSource" required>
        <option value="CSFloat">CSFloat</option>
        <option value="Steam">Steam</option>
      </select>
    </label>
    <br /><br />
    <button type="submit">Tallenna</button>
    <button type="button" id="cancelEdit">Peruuta</button>
  </form>

  <h2>Skinien lista</h2>

  <table id="skinsTable">
    <thead>
      <tr>
        <th>Skin</th>
        <th>Kulumamalli</th>
        <th>Osto (€)</th>
        <th>Myynti (€)</th>
        <th>Voitto (€)</th>
        <th>Voitto (%)</th>
        <th>Oston lähde</th>
        <th>Myynnin lähde</th>
        <th>Toiminnot</th>
      </tr>
    </thead>
    <tbody>
      <!-- Skin-rivit tulevat tänne -->
    </tbody>
  </table>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDj3YnvlbQPM5yvlYTEohrup65bQCBbwDY",
    authDomain: "vilin-mestari-sijoitus-voitot.firebaseapp.com",
    projectId: "vilin-mestari-sijoitus-voitot",
    storageBucket: "vilin-mestari-sijoitus-voitot.firebasestorage.app",
    messagingSenderId: "912067809877",
    appId: "1:912067809877:web:84c11fc354f5372dcb7adc",
    measurementId: "G-5683KL29W1"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const provider = new firebase.auth.GoogleAuthProvider();

  // DOM-elementit
  const loginBtn = document.getElementById('login-btn');
  const logoutBtn = document.getElementById('logout-btn');
  const userInfo = document.getElementById('user-info');
  const userNameSpan = document.getElementById('user-name');
  const form = document.getElementById('addSkinForm');
  const tableBody = document.querySelector('#skinsTable tbody');

  // Lomake kentät
  const skinNameInput = document.getElementById('skinName');
  const wearLevelInput = document.getElementById('wearLevel');
  const buyPriceInput = document.getElementById('buyPrice');
  const sellPriceInput = document.getElementById('sellPrice');
  const buySourceInput = document.getElementById('buySource');
  const sellSourceInput = document.getElementById('sellSource');
  const editIndexInput = document.getElementById('editIndex');
  const cancelEditBtn = document.getElementById('cancelEdit');

  let skins = [];
  let user = null;

  // Päivitä UI kirjautumistilan mukaan
  function updateUI(u) {
    user = u;
    if(user) {
      userInfo.style.display = 'block';
      loginBtn.style.display = 'none';
      userNameSpan.textContent = user.displayName || user.email;
      form.style.display = 'block';
      loadSkins();
    } else {
      userInfo.style.display = 'none';
      loginBtn.style.display = 'inline-block';
      userNameSpan.textContent = '';
      form.style.display = 'none';
      clearTable();
      skins = [];
    }
  }

  // Lataa skinit Firestoresta
  function loadSkins() {
    if(!user) return;
    db.collection('skins').where('uid', '==', user.uid).get()
      .then(querySnapshot => {
        skins = [];
        querySnapshot.forEach(doc => {
          const data = doc.data();
          data.id = doc.id;
          skins.push(data);
        });
        renderTable();
      })
      .catch(err => {
        alert("Virhe skinejä ladattaessa: " + err.message);
      });
  }

  // Kirjautumistila kuuntelija
  auth.onAuthStateChanged(u => {
    updateUI(u);
  });

  loginBtn.onclick = () => {
    auth.signInWithPopup(provider).catch(e => alert("Kirjautumisvirhe: " + e.message));
  };

  logoutBtn.onclick = () => {
    auth.signOut();
  };

  // Laskee erotukset ja prosentit
  function calculateProfit(buy, sell) {
    const profit = sell - buy;
    const profitPercent = buy > 0 ? (profit / buy) * 100 : 0;
    return { profit, profitPercent };
  }

  // Päivittää taulukon näkyväksi
  function renderTable() {
    clearTable();
    skins.forEach((skin, i) => {
      const tr = document.createElement('tr');

      const { profit, profitPercent } = calculateProfit(skin.buyPrice, skin.sellPrice);

      tr.innerHTML = `
        <td>${skin.name}</td>
        <td>${skin.wearLevel}</td>
        <td>${skin.buyPrice.toFixed(2)}</td>
        <td>${skin.sellPrice.toFixed(2)}</td>
        <td class="${profit >= 0 ? 'profit' : 'loss'}">${profit.toFixed(2)}</td>
        <td class="${profit >= 0 ? 'profit' : 'loss'}">${profitPercent.toFixed(2)}%</td>
        <td>${skin.buySource}</td>
        <td>${skin.sellSource}</td>
        <td>
          <button onclick="editSkin(${i})">Muokkaa</button>
          <button onclick="deleteSkin(${i})">Poista</button>
        </td>
      `;
      tableBody.appendChild(tr);
    });
  }

  function clearTable() {
    tableBody.innerHTML = '';
  }

  // Lisää tai päivitä skin Firestoreen
  form.onsubmit = (e) => {
    e.preventDefault();
    if(!user) {
      alert("Et ole kirjautunut!");
      return;
    }
    const name = skinNameInput.value.trim();
    const wearLevel = wearLevelInput.value;
    const buyPrice = parseFloat(buyPriceInput.value);
    const sellPrice = parseFloat(sellPriceInput.value);
    const buySource = buySourceInput.value;
    const sellSource = sellSourceInput.value;
    const editIndex = parseInt(editIndexInput.value);

    if(!name || isNaN(buyPrice) || isNaN(sellPrice)) {
      alert("Täytä kaikki kentät oikein!");
      return;
    }

    const skinObj = { 
      uid: user.uid,
      name, 
      wearLevel, 
      buyPrice, 
      sellPrice, 
      buySource, 
      sellSource 
    };

    if(editIndex >= 0 && skins[editIndex]) {
      // Päivitä Firestore-dokumentti
      const id = skins[editIndex].id;
      db.collection('skins').doc(id).set(skinObj)
        .then(() => {
          skins[editIndex] = { ...skinObj, id };
          renderTable();
          clearForm();
        })
        .catch(err => alert("Virhe päivitettäessä: " + err.message));
    } else {
      // Lisää uusi dokumentti
      db.collection('skins').add(skinObj)
        .then(docRef => {
          skins.push({ ...skinObj, id: docRef.id });
          renderTable();
          clearForm();
        })
        .catch(err => alert("Virhe lisättäessä: " + err.message));
    }
  };

  // Tyhjennä lomake ja nollaa muokkausindeksi
  function clearForm() {
    skinNameInput.value = '';
    wearLevelInput.value = 'Factory New';
    buyPriceInput.value = '';
    sellPriceInput.value = '';
    buySourceInput.value = 'CSFloat';
    sellSourceInput.value = 'CSFloat';
    editIndexInput.value = -1;
  }

  // Peruuta muokkaus
  cancelEditBtn.onclick = () => {
    clearForm();
  };

  // Muokkaa skin tietoja
  window.editSkin = function(i) {
    const skin = skins[i];
    skinNameInput.value = skin.name;
    wearLevelInput.value = skin.wearLevel;
    buyPriceInput.value = skin.buyPrice;
    sellPriceInput.value = skin.sellPrice;
    buySourceInput.value = skin.buySource;
    sellSourceInput.value = skin.sellSource;
    editIndexInput.value = i;
  };

  // Poista skin Firestoresta
  window.deleteSkin = function(i) {
    if(!user) {
      alert("Et ole kirjautunut!");
      return;
    }
    if(confirm("Haluatko varmasti poistaa tämän skinin?")) {
      const id = skins[i].id;
      db.collection('skins').doc(id).delete()
        .then(() => {
          skins.splice(i, 1);
          renderTable();
        })
        .catch(err => alert("Virhe poistettaessa: " + err.message));
    }
  };
</script>

</body>
</html>
