<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vilin Mestari Sijoitus Voitot</title>
  <style>
    /* Perusasetukset - tumma teema */
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #121212; /* erittäin tumma */
  margin: 0;
  padding: 20px;
  color: #ddd;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
}

h1, h2 {
  font-weight: 700;
  color: #ff6600; /* oranssi korostus */
}

/* Container */
.container {
  max-width: 960px;
  width: 100%;
  background: #1e1e1e; /* tummanharmaa */
  box-shadow: 0 6px 15px rgba(255, 102, 0, 0.3);
  border-radius: 8px;
  padding: 30px 40px;
  box-sizing: border-box;
}

/* Käyttäjätiedot ja nappulat */
#user-info {
  margin-bottom: 25px;
  font-size: 1.1rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #2a2a2a; /* tumma */
  padding: 10px 20px;
  border-radius: 6px;
  box-shadow: inset 0 0 8px #ff6600cc; /* oranssi hehku */
}

#user-info span {
  font-weight: 600;
  color: #ff6600;
}

button {
  background-color: #ff6600;
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: 5px;
  font-size: 1rem;
  cursor: pointer;
  transition: background-color 0.3s ease;
  user-select: none;
  box-shadow: 0 2px 6px rgba(255, 102, 0, 0.6);
}
button:hover {
  background-color: #e65500;
}
button:disabled {
  background-color: #ffad7a;
  cursor: not-allowed;
  box-shadow: none;
}

/* Lomake */
form#addSkinForm {
  margin-bottom: 30px;
  background: #222222;
  border: 1px solid #444;
  padding: 25px 20px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(255, 102, 0, 0.1);
}
form#addSkinForm h2 {
  margin-top: 0;
  margin-bottom: 20px;
  font-size: 1.4rem;
  color: #ff6600;
}

form#addSkinForm label {
  display: block;
  margin-bottom: 12px;
  font-weight: 600;
  color: #ddd;
}
form#addSkinForm input[type="text"],
form#addSkinForm input[type="number"],
form#addSkinForm select {
  width: 100%;
  padding: 8px 12px;
  font-size: 1rem;
  border: 1px solid #666;
  border-radius: 5px;
  box-sizing: border-box;
  background: #121212;
  color: #eee;
  transition: border-color 0.3s ease;
}
form#addSkinForm input[type="text"]:focus,
form#addSkinForm input[type="number"]:focus,
form#addSkinForm select:focus {
  border-color: #ff6600;
  outline: none;
  box-shadow: 0 0 6px #ff6600cc;
}

/* Lomake napit rinnakkain */
form#addSkinForm .buttons {
  margin-top: 20px;
  display: flex;
  gap: 15px;
}
form#addSkinForm .buttons button {
  flex: 1;
}

/* Tilastot */
#stats {
  margin-bottom: 30px;
  background: #2a2a2a;
  padding: 20px 30px;
  border-radius: 8px;
  box-shadow: inset 0 0 8px #ff6600cc;
  color: #ffad7a;
}
#stats p {
  font-size: 1.1rem;
  margin: 8px 0;
  font-weight: 600;
}

/* Haku */
#searchInput {
  padding: 10px 15px;
  font-size: 1rem;
  border-radius: 6px;
  border: 1px solid #666;
  width: 100%;
  max-width: 300px;
  margin-bottom: 20px;
  background: #121212;
  color: #eee;
  transition: border-color 0.3s ease;
}
#searchInput:focus {
  border-color: #ff6600;
  outline: none;
  box-shadow: 0 0 8px #ff6600cc;
}

/* Taulukko */
table#skinsTable {
  width: 100%;
  border-collapse: collapse;
  box-shadow: 0 2px 8px rgba(255, 102, 0, 0.3);
  border-radius: 8px;
  overflow: hidden;
  background: #1e1e1e;
  color: #ddd;
}
table#skinsTable thead {
  background-color: #ff6600;
  color: #1e1e1e;
  user-select: none;
}
table#skinsTable th, table#skinsTable td {
  padding: 12px 15px;
  text-align: center;
  border-bottom: 1px solid #333;
}
table#skinsTable th {
  cursor: pointer;
  font-weight: 700;
  font-size: 1rem;
  position: relative;
  user-select: none;
}
/* Lajittelun nuolet */
th.sort-asc::after,
th.sort-desc::after {
  content: '';
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  border: 6px solid transparent;
}
th.sort-asc::after {
  border-bottom-color: #1e1e1e;
}
th.sort-desc::after {
  border-top-color: #1e1e1e;
}

/* Taulukon rivien hover */
table#skinsTable tbody tr:hover {
  background-color: #333;
}

/* Voitto/tappio värit */
.profit {
  background-color: #3a5f0b;
  color: #a6ff00;
  font-weight: 600;
}
.loss {
  background-color: #6b0b0b;
  color: #ff4c4c;
  font-weight: 600;
}

/* Toimintopainikkeet */
table#skinsTable button {
  background-color: #cc5200;
  padding: 6px 10px;
  font-size: 0.9rem;
  margin: 0 4px;
  border-radius: 5px;
  box-shadow: 0 2px 6px rgba(204, 82, 0, 0.6);
  color: #fff;
}
table#skinsTable button:hover {
  background-color: #a44200;
}

/* Responsiivisuus */
@media (max-width: 720px) {
  .container {
    padding: 20px;
  }
  table#skinsTable th, table#skinsTable td {
    padding: 8px 6px;
    font-size: 0.85rem;
  }
  #searchInput {
    max-width: 100%;
  }
  form#addSkinForm label {
    font-size: 0.95rem;
  }
  form#addSkinForm input[type="text"],
  form#addSkinForm input[type="number"],
  form#addSkinForm select {
    font-size: 0.9rem;
  }
}

  </style>
</head>
<body>

  <div class="container">

    <h1>Vilin Mestari Sijoitus Voitot</h1>

    <div id="user-info" style="display:none;">
      Tervetuloa, <span id="user-name"></span>!
      <button id="logout-btn">Kirjaudu ulos</button>
    </div>
    <button id="login-btn">Kirjaudu Googlella</button>

    <form id="addSkinForm" style="display:none;">
      <h2>Lisää tai muokkaa skin</h2>
      <input type="hidden" id="editIndex" value="-1" />
      <label>
        Skinin nimi:
        <input type="text" id="skinName" required autocomplete="off" />
      </label>

      <label>
        Kulumamalli:
        <select id="wearLevel" required>
          <option value="Factory New">Factory New</option>
          <option value="Minimal Wear">Minimal Wear</option>
          <option value="Field Tested">Field Tested</option>
          <option value="Well Worn">Well Worn</option>
          <option value="Battle Scarred">Battle Scarred</option>
        </select>
      </label>

      <label>
        Osto (€/USD):
        <input type="number" step="0.01" id="buyPrice" required />
      </label>

      <label>
        Myynti (€/USD):
        <input type="number" step="0.01" id="sellPrice" required />
      </label>

      <label>
        Lähde ostolle:
        <select id="buySource" required>
          <option value="Steam Market">Steam Market</option>
          <option value="OP Skins">OP Skins</option>
          <option value="Third Party">Third Party</option>
        </select>
      </label>

      <div class="buttons">
        <button type="submit" id="addEditBtn">Lisää skin</button>
        <button type="button" id="cancelEditBtn" style="display:none;">Peruuta muokkaus</button>
      </div>
    </form>

    <input type="text" id="searchInput" placeholder="Hae skinejä nimellä tai lähteellä..." style="display:none;" />

    <div id="stats" style="display:none;">
      <p>Skinejä yhteensä: <span id="totalSkins">0</span></p>
      <p>Keskiosto: <span id="avgBuyPrice">0.00</span> €</p>
      <p>Keski-myyntihinta: <span id="avgSellPrice">0.00</span> €</p>
      <p>Keski-prosentti: <span id="avgProfitPercent">0.00</span> %</p>
    </div>

    <table id="skinsTable" style="display:none;">
      <thead>
        <tr>
          <th data-key="name">Skin</th>
          <th data-key="wear">Kulumamalli</th>
          <th data-key="buy">Osto (€)</th>
          <th data-key="sell">Myynti (€)</th>
          <th data-key="profit">Voitto (€)</th>
          <th data-key="profitPercent">Voitto (%)</th>
          <th data-key="source">Lähde</th>
          <th>Toiminnot</th>
        </tr>
      </thead>
      <tbody>
        <!-- Data lisääntyy tähän -->
      </tbody>
    </table>

  </div>

  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>

  <script>
    // Tässä sinun Firebase-konfiguraatiosi:
    const firebaseConfig = {
      apiKey: "AIzaSyDj3YnvlbQPM5yvlYTEohrup65bQCBbwDY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM-elementit
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const userInfo = document.getElementById('user-info');
    const userNameSpan = document.getElementById('user-name');

    const addSkinForm = document.getElementById('addSkinForm');
    const skinNameInput = document.getElementById('skinName');
    const wearLevelSelect = document.getElementById('wearLevel');
    const buyPriceInput = document.getElementById('buyPrice');
    const sellPriceInput = document.getElementById('sellPrice');
    const buySourceSelect = document.getElementById('buySource');
    const addEditBtn = document.getElementById('addEditBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const editIndexInput = document.getElementById('editIndex');

    const searchInput = document.getElementById('searchInput');
    const statsDiv = document.getElementById('stats');
    const totalSkinsSpan = document.getElementById('totalSkins');
    const avgBuyPriceSpan = document.getElementById('avgBuyPrice');
    const avgSellPriceSpan = document.getElementById('avgSellPrice');
    const avgProfitPercentSpan = document.getElementById('avgProfitPercent');

    const skinsTable = document.getElementById('skinsTable');
    const skinsTableBody = skinsTable.querySelector('tbody');

    let skins = [];
    let sortKey = null;
    let sortAsc = true;

    // Google-kirjautuminen
    loginBtn.onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(err => alert("Kirjautumisvirhe: " + err.message));
    };

    logoutBtn.onclick = () => auth.signOut();

    // Kuuntele kirjautumistila
    auth.onAuthStateChanged(user => {
      if (user) {
        userNameSpan.textContent = user.displayName;
        loginBtn.style.display = 'none';
        userInfo.style.display = 'flex';
        addSkinForm.style.display = 'block';
        searchInput.style.display = 'block';
        statsDiv.style.display = 'block';
        skinsTable.style.display = 'table';

        // Lataa skinit Firestoresta käyttäjäkohtaisesti
        loadSkins(user.uid);
      } else {
        userNameSpan.textContent = '';
        loginBtn.style.display = 'block';
        userInfo.style.display = 'none';
        addSkinForm.style.display = 'none';
        searchInput.style.display = 'none';
        statsDiv.style.display = 'none';
        skinsTable.style.display = 'none';

        skins = [];
        renderSkins();
        clearForm();
      }
    });

    function loadSkins(uid) {
      // Firestore: Kuuntele reaaliaikaisesti käyttäjän skin-kokoelmaa
      db.collection('users').doc(uid).collection('skins')
        .onSnapshot(snapshot => {
          skins = [];
          snapshot.forEach(doc => {
            skins.push({...doc.data(), id: doc.id});
          });
          renderSkins();
          calculateStats();
        }, error => {
          alert("Virhe tietojen latauksessa: " + error.message);
        });
    }

    // Lomakkeen lähetys (lisää/muokkaa)
    addSkinForm.onsubmit = e => {
      e.preventDefault();

      const skinData = {
        name: skinNameInput.value.trim(),
        wear: wearLevelSelect.value,
        buy: parseFloat(buyPriceInput.value),
        sell: parseFloat(sellPriceInput.value),
        source: buySourceSelect.value
      };

      if (skinData.name === '' || isNaN(skinData.buy) || isNaN(skinData.sell)) {
        alert('Täytä kaikki kentät oikein!');
        return;
      }

      const user = auth.currentUser;
      if (!user) return alert('Et ole kirjautunut sisään!');

      const skinId = editIndexInput.value;
      if (skinId === '-1') {
        // Lisää uusi
        db.collection('users').doc(user.uid).collection('skins').add(skinData).then(() => {
          clearForm();
        }).catch(err => alert('Virhe lisättäessä: ' + err.message));
      } else {
        // Päivitä olemassaoleva
        db.collection('users').doc(user.uid).collection('skins').doc(skinId).update(skinData).then(() => {
          clearForm();
        }).catch(err => alert('Virhe päivitettäessä: ' + err.message));
      }
    };

    cancelEditBtn.onclick = () => clearForm();

    // Tyhjennä lomake ja palauta oletukset
    function clearForm() {
      editIndexInput.value = '-1';
      skinNameInput.value = '';
      wearLevelSelect.value = 'Factory New';
      buyPriceInput.value = '';
      sellPriceInput.value = '';
      buySourceSelect.value = 'Steam Market';
      addEditBtn.textContent = 'Lisää skin';
      cancelEditBtn.style.display = 'none';
    }

    // Renderöi taulukko skineistä
    function renderSkins() {
      // Suodata haun mukaan
      const filterText = searchInput.value.trim().toLowerCase();
      let filtered = skins.filter(skin => 
        skin.name.toLowerCase().includes(filterText) ||
        skin.source.toLowerCase().includes(filterText)
      );

      // Lajittele
      if (sortKey) {
        filtered.sort((a,b) => {
          let valA = a[sortKey];
          let valB = b[sortKey];
          // Jos numerot, vertaa numeerisesti
          if(sortKey === 'buy' || sortKey === 'sell' || sortKey === 'profit' || sortKey === 'profitPercent') {
            valA = (sortKey === 'profit' || sortKey === 'profitPercent') ? (a.sell - a.buy) : valA;
            valB = (sortKey === 'profit' || sortKey === 'profitPercent') ? (b.sell - b.buy) : valB;
            return sortAsc ? valA - valB : valB - valA;
          }
          // Muuten merkkijonovertailu
          if(valA < valB) return sortAsc ? -1 : 1;
          if(valA > valB) return sortAsc ? 1 : -1;
          return 0;
        });
      }

      skinsTableBody.innerHTML = '';
      if(filtered.length === 0){
        skinsTableBody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding:20px; color:#888;">Ei näytettäviä skinejä</td></tr>`;
        return;
      }

      for (const skin of filtered) {
        const profit = skin.sell - skin.buy;
        const profitPercent = (profit / skin.buy) * 100;
        const profitClass = profit >= 0 ? 'profit' : 'loss';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${skin.name}</td>
          <td>${skin.wear}</td>
          <td>${skin.buy.toFixed(2)}</td>
          <td>${skin.sell.toFixed(2)}</td>
          <td class="${profitClass}">${profit.toFixed(2)}</td>
          <td class="${profitClass}">${profitPercent.toFixed(2)}%</td>
          <td>${skin.source}</td>
          <td>
            <button onclick="editSkin('${skin.id}')">Muokkaa</button>
            <button onclick="deleteSkin('${skin.id}')">Poista</button>
          </td>
        `;
        skinsTableBody.appendChild(tr);
      }
    }

    // Muokkaa skinia
    window.editSkin = function(id) {
      const skin = skins.find(s => s.id === id);
      if (!skin) return;
      editIndexInput.value = skin.id;
      skinNameInput.value = skin.name;
      wearLevelSelect.value = skin.wear;
      buyPriceInput.value = skin.buy;
      sellPriceInput.value = skin.sell;
      buySourceSelect.value = skin.source;
      addEditBtn.textContent = 'Tallenna muutokset';
      cancelEditBtn.style.display = 'inline-block';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    // Poista skin
    window.deleteSkin = function(id) {
      if (!confirm('Haluatko varmasti poistaa tämän skinin?')) return;
      const user = auth.currentUser;
      if (!user) return alert('Et ole kirjautunut sisään!');
      db.collection('users').doc(user.uid).collection('skins').doc(id).delete()
        .catch(err => alert('Virhe poistettaessa: ' + err.message));
    };

    // Päivitä tilastot
    function calculateStats() {
      if (skins.length === 0) {
        totalSkinsSpan.textContent = '0';
        avgBuyPriceSpan.textContent = '0.00';
        avgSellPriceSpan.textContent = '0.00';
        avgProfitPercentSpan.textContent = '0.00';
        return;
      }
      const total = skins.length;
      const sumBuy = skins.reduce((a, s) => a + s.buy, 0);
      const sumSell = skins.reduce((a, s) => a + s.sell, 0);
      const sumProfitPercent = skins.reduce((a, s) => a + ((s.sell - s.buy) / s.buy) * 100, 0);

      totalSkinsSpan.textContent = total;
      avgBuyPriceSpan.textContent = (sumBuy / total).toFixed(2);
      avgSellPriceSpan.textContent = (sumSell / total).toFixed(2);
      avgProfitPercentSpan.textContent = (sumProfitPercent / total).toFixed(2);
    }

    // Haku
    searchInput.oninput = () => renderSkins();

    // Taulukon otsikot lajitteluun
    document.querySelectorAll('#skinsTable thead th[data-key]').forEach(th => {
      th.addEventListener('click', () => {
        const key = th.getAttribute('data-key');
        if (sortKey === key) {
          sortAsc = !sortAsc;
        } else {
          sortKey = key;
          sortAsc = true;
        }
        // Poista lajittelun merkit muista sarakkeista
        document.querySelectorAll('#skinsTable thead th').forEach(h => h.classList.remove('sort-asc','sort-desc'));
        th.classList.add(sortAsc ? 'sort-asc' : 'sort-desc');
        renderSkins();
      });
    });

  </script>

</body>
</html>