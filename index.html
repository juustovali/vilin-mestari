<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vilin Mestari Sijoitus Voitot</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #user-info { margin-bottom: 15px; }
    #addSkinForm { margin-bottom: 20px; }
    table { border-collapse: collapse; width: 100%; max-width: 900px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #eee; cursor: pointer; user-select: none; }
    th.sort-asc::after { content: " ▲"; }
    th.sort-desc::after { content: " ▼"; }
    .profit { background-color: #d4f8d4; }   /* vihreä voitto */
    .loss { background-color: #f8d4d4; }     /* punainen tappio */
    button { cursor: pointer; }
    #searchInput { margin-bottom: 15px; padding: 5px; width: 250px; }
  </style>
</head>
<body>

  <div id="user-info" style="display:none;">
    Tervetuloa, <span id="user-name"></span>!
    <button id="logout-btn">Kirjaudu ulos</button>
  </div>
  <button id="login-btn">Kirjaudu Googlella</button>

  <form id="addSkinForm" style="display:none;">
    <h2>Lisää tai muokkaa skin</h2>
    <input type="hidden" id="editIndex" value="-1" />
    <label>
      Skinin nimi: <input type="text" id="skinName" required />
    </label>
    <br />
    <label>
      Kulumamalli: 
      <select id="wearLevel" required>
        <option value="Factory New">Factory New</option>
        <option value="Minimal Wear">Minimal Wear</option>
        <option value="Field Tested">Field Tested</option>
        <option value="Well Worn">Well Worn</option>
        <option value="Battle Scarred">Battle Scarred</option>
      </select>
    </label>
    <br />
    <label>
      Osto (€/USD): <input type="number" step="0.01" id="buyPrice" required />
    </label>
    <br />
    <label>
      Myynti (€/USD): <input type="number" step="0.01" id="sellPrice" required />
    </label>
    <br />
    <label>
      Lähde ostolle: 
      <select id="buySource" required>
        <option value="CSFloat">CSFloat</option>
        <option value="Steam">Steam</option>
      </select>
    </label>
    <br />
    <label>
      Lähde myynnille: 
      <select id="sellSource" required>
        <option value="CSFloat">CSFloat</option>
        <option value="Steam">Steam</option>
      </select>
    </label>
    <br /><br />
    <button type="submit">Tallenna</button>
    <button type="button" id="cancelEdit">Peruuta</button>
  </form>

  <h2>Skinien lista</h2>

  <!-- Hakukenttä -->
  <input type="text" id="searchInput" placeholder="Hae skin-nimellä..." />

  <table id="skinsTable">
    <thead>
      <tr>
        <th data-sort="name">Skin</th>
        <th data-sort="wearLevel">Kulumamalli</th>
        <th data-sort="buyPrice">Osto (€)</th>
        <th data-sort="sellPrice">Myynti (€)</th>
        <th>Voitto (€)</th>
        <th>Voitto (%)</th>
        <th data-sort="buySource">Oston lähde</th>
        <th data-sort="sellSource">Myynnin lähde</th>
        <th>Toiminnot</th>
      </tr>
    </thead>
    <tbody>
      <!-- Skin-rivit tulevat tänne -->
    </tbody>
  </table>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDj3YnvlbQPM5yvlYTEohrup65bQCBbwDY",
    authDomain: "vilin-mestari-sijoitus-voitot.firebaseapp.com",
    projectId: "vilin-mestari-sijoitus-voitot",
    storageBucket: "vilin-mestari-sijoitus-voitot.firebasestorage.app",
    messagingSenderId: "912067809877",
    appId: "1:912067809877:web:84c11fc354f5372dcb7adc",
    measurementId: "G-5683KL29W1"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const provider = new firebase.auth.GoogleAuthProvider();

  // DOM-elementit
  const loginBtn = document.getElementById('login-btn');
  const logoutBtn = document.getElementById('logout-btn');
  const userInfo = document.getElementById('user-info');
  const userNameSpan = document.getElementById('user-name');
  const form = document.getElementById('addSkinForm');
  const tableBody = document.querySelector('#skinsTable tbody');
  const searchInput = document.getElementById('searchInput');

  // Lomake kentät
  const skinNameInput = document.getElementById('skinName');
  const wearLevelInput = document.getElementById('wearLevel');
  const buyPriceInput = document.getElementById('buyPrice');
  const sellPriceInput = document.getElementById('sellPrice');
  const buySourceInput = document.getElementById('buySource');
  const sellSourceInput = document.getElementById('sellSource');
  const editIndexInput = document.getElementById('editIndex');
  const cancelEditBtn = document.getElementById('cancelEdit');

  let skins = [];
  let filteredSkins = [];
  let user = null;

  // Järjestysmuuttujat
  let currentSort = { key: null, direction: 'asc' };

  // Päivitä UI kirjautumistilan mukaan
  function updateUI(u) {
    user = u;
    if(user) {
      userInfo.style.display = 'block';
      loginBtn.style.display = 'none';
      userNameSpan.textContent = user.displayName || user.email;
      form.style.display = 'block';
      searchInput.style.display = 'inline-block';
      subscribeToSkins();  // Reaaliaikainen kuuntelu Firestoreen
    } else {
      userInfo.style.display = 'none';
      loginBtn.style.display = 'inline-block';
      userNameSpan.textContent = '';
      form.style.display = 'none';
      searchInput.style.display = 'none';
      clearTable();
      skins = [];
      filteredSkins = [];
      // Lopetetaan realtime kuuntelu uloskirjautuessa
      if(window.unsubscribeSkins) {
        window.unsubscribeSkins();
        window.unsubscribeSkins = null;
      }
    }
  }

  // Reaaliaikainen päivitys Firestoresta
  function subscribeToSkins() {
    if(!user) return;
    if(window.unsubscribeSkins) window.unsubscribeSkins();

    window.unsubscribeSkins = db.collection('skins')
      .where('uid', '==', user.uid)
      .onSnapshot(querySnapshot => {
        skins = [];
        querySnapshot.forEach(doc => {
          const data = doc.data();
          data.id = doc.id;
          skins.push(data);
        });
        filteredSkins = [...skins];
        renderTable();
      }, err => {
        console.error("Virhe reaaliaikaisessa päivityksessä:", err);
        alert("Virhe reaaliaikaisessa päivityksessä: " + err.message);
      });
  }

  // Kirjautumistila kuuntelija
  auth.onAuthStateChanged(u => {
    updateUI(u);
  });

  loginBtn.onclick = () => {
    auth.signInWithPopup(provider).catch(e => {
      console.error("Kirjautumisvirhe:", e);
      alert("Kirjautumisvirhe: " + e.message);
    });
  };

  logoutBtn.onclick = () => {
    auth.signOut().catch(e => {
      console.error("Uloskirjautumisvirhe:", e);
      alert("Virhe uloskirjautuessa: " + e.message);
    });
  };

  // Laskee erotukset ja prosentit
  function calculateProfit(buy, sell) {
    const profit = sell - buy;
    const profitPercent = buy > 0 ? (profit / buy) * 100 : 0;
    return { profit, profitPercent };
  }

  // Päivittää taulukon näkyväksi
  function renderTable() {
    clearTable();

    // Järjestä ensin, jos asetettu
    let skinsToShow = filteredSkins;
    if(currentSort.key) {
      skinsToShow = skinsToShow.slice().sort((a,b) => {
        let valA = a[currentSort.key];
        let valB = b[currentSort.key];

        // Jos numerot
        if(typeof valA === 'number' && typeof valB === 'number') {
          return currentSort.direction === 'asc' ? valA - valB : valB - valA;
        }
        // Merkkijonovertailu
        valA = valA ? valA.toString().toLowerCase() : '';
        valB = valB ? valB.toString().toLowerCase() : '';
        if(valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
        if(valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
        return 0;
      });
    }

    skinsToShow.forEach((skin, i) => {
      const tr = document.createElement('tr');
      const { profit, profitPercent } = calculateProfit(skin.buyPrice, skin.sellPrice);

      tr.innerHTML = `
        <td>${skin.name}</td>
        <td>${skin.wearLevel}</td>
        <td>${skin.buyPrice.toFixed(2)}</td>
        <td>${skin.sellPrice.toFixed(2)}</td>
        <td class="${profit >= 0 ? 'profit' : 'loss'}">${profit.toFixed(2)}</td>
        <td class="${profit >= 0 ? 'profit' : 'loss'}">${profitPercent.toFixed(2)}%</td>
        <td>${skin.buySource}</td>
        <td>${skin.sellSource}</td

