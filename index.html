<!DOCTYPE html> 
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vilin Mestari Sijoitus Voitot</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #user-info { margin-bottom: 15px; }
    #addSkinForm { margin-bottom: 20px; }
    table { border-collapse: collapse; width: 100%; max-width: 900px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; cursor: default; }
    th.sortable { cursor: pointer; background: #ddd; }
    th.sortable:hover { background: #ccc; }
    .profit { background-color: #d4f8d4; }   /* vihreä voitto */
    .loss { background-color: #f8d4d4; }     /* punainen tappio */
    button { cursor: pointer; }
    #filters {
      margin-bottom: 15px;
    }
    #filters label {
      margin-right: 15px;
    }
  </style>
</head>
<body>

  <div id="user-info" style="display:none;">
    Tervetuloa, <span id="user-name"></span>!
    <button id="logout-btn">Kirjaudu ulos</button>
  </div>
  <button id="login-btn">Kirjaudu Googlella</button>

  <form id="addSkinForm" style="display:none;">
    <h2>Lisää tai muokkaa skin</h2>
    <input type="hidden" id="editIndex" value="-1" />
    <label>
      Skinin nimi: <input type="text" id="skinName" required />
    </label>
    <br />
    <label>
      Kulumamalli: 
      <select id="wearLevel" required>
        <option value="Factory New">Factory New</option>
        <option value="Minimal Wear">Minimal Wear</option>
        <option value="Field Tested">Field Tested</option>
        <option value="Well Worn">Well Worn</option>
        <option value="Battle Scarred">Battle Scarred</option>
      </select>
    </label>
    <br />
    <label>
      Osto (€/USD): <input type="number" step="0.01" id="buyPrice" required />
    </label>
    <br />
    <label>
      Myynti (€/USD): <input type="number" step="0.01" id="sellPrice" required />
    </label>
    <br />
    <label>
      Lähde ostolle: 
      <select id="buySource" required>
        <option value="CSFloat">CSFloat</option>
        <option value="Steam">Steam</option>
      </select>
    </label>
    <br />
    <label>
      Lähde myynnille: 
      <select id="sellSource" required>
        <option value="CSFloat">CSFloat</option>
        <option value="Steam">Steam</option>
      </select>
    </label>
    <br /><br />
    <button type="submit">Tallenna</button>
    <button type="button" id="cancelEdit">Peruuta</button>
  </form>

  <!-- Lisätty hakukenttä ja suodatus -->
  <div id="filters" style="display:none;">
    <label>
      Haku skinin nimellä: 
      <input type="text" id="searchInput" placeholder="Kirjoita nimi..." />
    </label>

    <label>
      Suodatin:
      <select id="filterSelect">
        <option value="all">Kaikki</option>
        <option value="profit">Voitolliset</option>
        <option value="loss">Tappiolliset</option>
      </select>
    </label>
  </div>

  <h2>Skinien lista</h2>

  <table id="skinsTable">
    <thead>
      <tr>
        <th class="sortable" data-key="name">Skin &#x25B2;&#x25BC;</th>
        <th>Kulumamalli</th>
        <th class="sortable" data-key="buyPrice">Osto (€) &#x25B2;&#x25BC;</th>
        <th class="sortable" data-key="sellPrice">Myynti (€) &#x25B2;&#x25BC;</th>
        <th class="sortable" data-key="profit">Voitto (€) &#x25B2;&#x25BC;</th>
        <th class="sortable" data-key="profitPercent">Voitto (%) &#x25B2;&#x25BC;</th>
        <th>Oston lähde</th>
        <th>Myynnin lähde</th>
        <th>Toiminnot</th>
      </tr>
    </thead>
    <tbody>
      <!-- Skin-rivit tulevat tänne -->
    </tbody>
  </table>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDj3YnvlbQPM5yvlYTEohrup65bQCBbwDY",
    authDomain: "vilin-mestari-sijoitus-voitot.firebaseapp.com",
    projectId: "vilin-mestari-sijoitus-voitot",
    storageBucket: "vilin-mestari-sijoitus-voitot.firebasestorage.app",
    messagingSenderId: "912067809877",
    appId: "1:912067809877:web:84c11fc354f5372dcb7adc",
    measurementId: "G-5683KL29W1"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const provider = new firebase.auth.GoogleAuthProvider();

  // DOM-elementit
  const loginBtn = document.getElementById('login-btn');
  const logoutBtn = document.getElementById('logout-btn');
  const userInfo = document.getElementById('user-info');
  const userNameSpan = document.getElementById('user-name');
  const form = document.getElementById('addSkinForm');
  const tableBody = document.querySelector('#skinsTable tbody');
  const filtersDiv = document.getElementById('filters');

  // Lomake kentät
  const skinNameInput = document.getElementById('skinName');
  const wearLevelInput = document.getElementById('wearLevel');
  const buyPriceInput = document.getElementById('buyPrice');
  const sellPriceInput = document.getElementById('sellPrice');
  const buySourceInput = document.getElementById('buySource');
  const sellSourceInput = document.getElementById('sellSource');
  const editIndexInput = document.getElementById('editIndex');
  const cancelEditBtn = document.getElementById('cancelEdit');

  // Hakusuodatin kentät
  const searchInput = document.getElementById('searchInput');
  const filterSelect = document.getElementById('filterSelect');

  let skins = [];
  let user = null;

  // Sorttaus tila
  let currentSort = { key: null, asc: true };

  // Päivitä UI kirjautumistilan mukaan
  function updateUI(u) {
    user = u;
    if(user) {
      userInfo.style.display = 'block';
      loginBtn.style.display = 'none';
      userNameSpan.textContent = user.displayName || user.email;
      form.style.display = 'block';
      filtersDiv.style.display = 'block';
      loadSkins();
    } else {
      userInfo.style.display = 'none';
      loginBtn.style.display = 'inline-block';
      userNameSpan.textContent = '';
      form.style.display = 'none';
      filtersDiv.style.display = 'none';
      clearTable();
      skins = [];
    }
  }

  // Lataa skinit Firestoresta
  function loadSkins() {
    if(!user) return;
    db.collection('skins').where('uid', '==', user.uid).get()
      .then(querySnapshot => {
        skins = [];
        querySnapshot.forEach(doc => {
          const data = doc.data();
          data.id = doc.id;
          skins.push(data);
        });
        renderTable();
      })
      .catch(err => {
        alert("Virhe skinejä ladattaessa: " + err.message);
      });
  }

  // Kirjautumistila kuuntelija
  auth.onAuthStateChanged(u => {
    updateUI(u);
  });

  loginBtn.onclick = () => {
    auth.signInWithPopup(provider).catch(e => alert("Kirjautumisvirhe: " + e.message));
  };

  logoutBtn.onclick = () => {
    auth.signOut();
  };

  // Laskee erotukset ja prosentit
  function calculateProfit(buy, sell) {
    const profit = sell - buy;
    const profitPercent = buy > 0 ? (profit / buy) * 100 : 0;
    return { profit, profitPercent };
  }

  // Sorttausfunktio
  function sortTable(key) {
    if(currentSort.key === key) {
      currentSort.asc = !currentSort.asc; // Vaihda suuntaa jos sama sarake
    } else {
      currentSort.key = key;
      currentSort.asc = true;
    }
    renderTable();
  }

  // Lisää eventlistenerit otsikoihin
  document.querySelectorAll('th.sortable').forEach(th => {
    th.addEventListener('click', () => {
      const key = th.getAttribute('data-key');
      sortTable(key);
    });
  });

  // Päivittää taulukon näkyväksi
  function renderTable() {
    clearTable();

    const searchTerm = searchInput.value.trim().toLowerCase();
    let filteredSkins = skins.filter(skin =>
      skin.name.toLowerCase().includes(searchTerm)
    );

    // Suodatetaan voitolliset / tappiolliset
    if(filterSelect.value === 'profit') {
      filteredSkins = filteredSkins.filter(skin => skin.sellPrice - skin.buyPrice > 0);
    } else if(filterSelect.value === 'loss') {
      filteredSkins = filteredSkins.filter(skin => skin.sellPrice - skin.buyPrice < 0);
    }

    // Sortataan jos valittu
    if(currentSort.key) {
      filteredSkins.sort((a,b) => {
        let valA, valB;

        if(currentSort.key === 'profit') {
          valA = a.sellPrice - a.buyPrice;
          valB = b.sellPrice - b.buyPrice;
        } else if(currentSort.key === 'profitPercent') {
          valA = ((a.sellPrice - a.buyPrice) / a.buyPrice) || 0;
          valB = ((b.sellPrice - b.buyPrice) / b.buyPrice) || 0;
        } else {
          valA = a[currentSort.key];
          valB = b[currentSort.key];
        }

        if(typeof valA === 'string') valA = valA.toLowerCase();
        if(typeof valB === 'string') valB = valB.toLowerCase();

        if(valA < valB) return currentSort.asc ? -1 : 1;
        if(valA > valB) return currentSort.asc ? 1 : -1;
        return 0;
      });
    }

    filteredSkins.forEach((skin, i) => {
      const tr = document.createElement('tr');
      const { profit, profitPercent } = calculateProfit(skin.buyPrice, skin.sellPrice);

      tr.innerHTML = `
        <td>${skin.name}</td>
        <td>${skin.wearLevel}</td>
        <td>${skin.buyPrice.toFixed(2)}</td>
        <td>${skin.sellPrice.toFixed(2)}</td>
        <
</body>
</html>
